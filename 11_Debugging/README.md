
# デバッグについて
「プログラムは思った通りに動かない。書いた通りに動く」とは誰の言葉だったか。  
未知のバグを検出するための手順。    
既知のバグを修正するための手順。  
プログラムを意図した通りに動作させるための手順。  

初めに基本的な事柄について説明して、Visual Studio Codeの機能、Chromeの機能を把握する。

# バグ（不具合）について
この章では自身の想定と実際が乖離したケースのみ取り扱う。  
メンバ、顧客間で意志疎通取れなかったケースなどは除外する。  

# バグの発生を抑える
[08_Refactoring](08_Refactoring/README.md)  
[09_Lint](09_Lint/README.md)  
[10_CodingStandards](10_CodingStandards/README.md)  
を参照。  
不具合の発生しそうな記述を禁止する。  
バグを埋め込みにくく、検知しやすく、修正が容易な構造にする。 

# バグが発生したことを検知する
テストを書く。  
別の章で解説。

# デバッグの手順 

1. バグは確かにあるのか確認する
1. 不具合の再現方法と原因を調査する
1. 正しい挙動は？どうなればバグが修正したと言えるのか把握する
1. 不具合を解決するための情報収集をおこなう
1. 修正する
1. 不具合が修正されたことを確認する
1. 似たような不具合がないか確認する

2〜4に関しては順不同

# 不具合の種類
- 仕様ミス
- 実装ミス
- データミス
- ネットワークエラーなどの例外想定ミス
など

# 技術的アプローチ

## コンソール出力 画面出力
printf, var_dumpなどとも呼ばれる。  
開発環境が貧弱すぎる場合や、マルチスレッド処理などでは重要になってくるケースがある。  

## ログ出力

主に本番環境で不具合が発生した時に備えて利用される。  
不具合の発生箇所、環境、時間、原因がわかるように事前に設計しておく必要がある。5w1hあたりを意識すると良い。

## エラーメッセージ
ここでは自分で埋め込んだもの以外で出力されるメッセージやログのこと。
表現に若干癖がある。習うより慣れる。  

出力されるメッセージから検索をおこなう。
ようするにググる。  
汎用的なメッセージは環境も条件に含める。  
バージョンで挙動が異なる場合期間指定する。  
検索キーワードから固有名詞を除外する。  
限定的で狭いキーワードから開始して徐々に汎用的なキーワードへ変更していく（laravel → PHP など）  
qiitaは危険。使う前に検証が必要。  
英語情報も避けずに参照する。  
Stackoverflowは大体あってる（海外の人曰くStackoverflowも信用してはいけないらしい）  
サンプルをズバリ取得したい場合GitHub上で検索するのもアリ。その性質上基本的に動作確認が行われておりスターが多いものは信頼できる（絶対ではない）  

## ブレイクポイント
プログラムをある地点で止めて変数を確認する。  
仕様・実装内容の解析の面が強い。

- 特定の行が実行されるときにプログラムを止める
- 例外発生時に止める
- 特定の条件で止める
- 1行ずつ実行する
- 特定の変数・計算式を確認する
- 呼び出し階層を確認する
- 値の書き換え
などは最近の開発環境なら標準で存在する。

## I/F データやファイル
実際に不具合が報告される場合は大抵最終出力結果なのでそこから絞り込んでいく。  

### 画面の表示がおかしい
- 表示項目はどこから持ってきているか。
- データは加工して表示しているか
- データ取得元の値は想定通りか
  - 想定通りならばデータ取得以降がおかしい。今までは正常だったか。あるいは誰も気づいていなかっただけか。
  - 想定通りでないならいつ不正データが入ったか。手動で入れた。普段と違うオペレーションだった。

# 二分法
例えば1, 2, 3, 4, 5, 6 の順に流れる処理ある場合、中央の3から検証してそこまで正しいことが確認できれば問題は4以降に存在することが証明できる。  
次に5を検証してそれより前に問題があることが確認できれば4が原因であると特定できる。  

規模が大きいほど有効。  
マルチスレッド周りの不具合など一部ケースでは適用できない。  

# バグが埋め込んだ 正しく動作していた時期を把握している

以前まで動いていた部分に不備が生じるパターン。  
ほとんどのケースで直近の修正が影響している。
正しかったときと現在の差分を取ればOK。  
環境も考慮すること(PC,ツール,サーバなど)  

# バグが埋め込んだ 時期がわからない

大体あまり見たくないところ(難解なところ)に埋め込まれているので分かりずらいところから見ていく。

# すでにバグだらけのケース
~~諦める~~  

- まずコードに対する理解が必要。少し遠回りだが簡単なところから見ていく。
- うまくいっている箇所、上手くいっていない箇所を切り分ける
- 「作り直す」は多くのケースで悪手
- どうしようもない場合作り直す


# Visual Studio Codeのデバッグ周り

.vscode/launch.json の設定を元にF5でデバッグ実行できる。  
jsファイルなど一部ファイルはlaunch.jsonを設定せずに(設定していない場合)ファイルを開いてF5を押すだけでデバッグ実行できる。  
debug.jsを開いてF5を押して確認してみる。

## ブレイクポイント

行番号の左側をダブルクリックするとその行が実行されるときに処理を止めることができる。
ブレイクポイントを右クリック→ブレイクポイントの編集から止める条件を設定できる。
処理を止めている間は値の確認、書き換えが可能。

![ブレイクポイント](cap/vscode1.PNG)


## ウォッチ

処理を止めている間、任意の式を実行確認できる。  
デバッグコンソールでも同様のことが可能。  

![ウォッチ](cap/vscode2.PNG)


## console.log

デバッグコンソールに出力する。
マルチスレッド処理などでは重要になってくる。


# Chromeの開発者ツール
主に使用するのはElements, Console, Sources, Networkあたり。  

適当なウェブサイトかあるいは 06_DOM/06_index.html で確認する。

## Windowsで開く

```
06_DOM/06_index.html
```

## MACで開く

```
open 06_DOM/06_index.html
```


## Elements

ツリー形式でHTML構造を参照することができる。  
Ctrl(Cmd) + F でHTML内の検索。  
右クリックから
- Edit as HTML → HTMLの編集
- Delete element → 削除
など

![Chrome1](cap/chrome1.PNG)


### Styles
適用されたcssの確認。
:hov elementをactive,focusなど状態を変更できる。その時のcssの確認もできる。  
:cls クラスを追加できる。  

### Comuputed
最終的なスタイルを表示する。  

### Event Listener
elementに付与されているイベントリスナを確認する。  

### Propaties
選択中のelementの詳細などを確認できる。  

## Console
式の評価、ログの確認。  
カーソル上下で入力履歴。  
補完。  

## Sources
スクリプトの確認、実行コード整形、変更、コード整形、デバッグ。  
スニペット登録・実行。  

### Page
js, cssを確認できる。  
ブレイクポイントを貼ることも可能。  

![Chrome11](cap/chrome11.PNG)


### Snippets
Sources → Snippets からコードスニペットが作成できる。  
補完、デバッグ実行、保存(おそらくデバイス単位)が可能。  

![Chrome2](cap/chrome2.PNG)

### Watch
式の評価。  

### Call Stack
呼び出し履歴

### Grobal Listeners
登録されたイベントリスナを確認できる。  

## Network
通信の確認。取得ファイル確認。通信パフォーマンス確認。  
ヘッダ情報とレスポンス情報の確認。  

![Chrome6](cap/chrome6.PNG)


## Performance
任意の期間におpけるパフォーマンスを測ることができる。  
レコードCtrl(Cmd) + E で計測を開始する。

![Chrome7](cap/chrome7.PNG)

## Memory
メモリ使用量確認。

![Chrome8](cap/chrome8.PNG)

## Application
Manifest確認。Service Worker確認。キャッシュの削除。  
ローカルDB確認。キャッシュ確認。Cookie確認・編集。

## Audits
ウェブの診断が可能。http,httpsのみ。
パフォーマンス、PWA対応状況、SEO、改善点などが確認できる。  
特にパフォーマンスとSEOは便利（デバッグとはあまり関係ないが）  

![Chrome9](cap/chrome9.PNG)

## Rendering
Hide Console Drawer(Esc) → ハンバーガーメニューから  
描画に関していろいろ設定確認可能。  
FPS, css mediaの変更(orint, screen)  
ウェブ帳票を作成するときなどに。  

![Chrome3](cap/chrome3.PNG)


## Search
Hide Console Drawer(Esc) → ハンバーガーメニューから  
HTMLやファイルから検索。  

![Chrome4](cap/chrome4.PNG)

## Sensors
位置情報エミュレート。  
デバイスの向きエミュレート。  

## Coverage
jsの実行されたコードの割合が表示される。  

![Chrome5](cap/chrome5.PNG)

## Network conditions
通信速度のエミュレート。  
通信環境が悪い状態で動作確認できる。  

![Chrome10](cap/chrome10.PNG)

## その他
機能が多過ぎて説明しきれない。

- Animations
- Changes
- Quick Source
- Remote Devices
- Request blocking
- 

# 参考

https://xn--97-273ae6a4irb6e2hsoiozc2g4b8082p.com/%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA/%E3%83%90%E3%82%B0%E3%81%A8%E3%81%9D%E3%81%AE%E4%BF%AE%E6%AD%A3/

https://code.visualstudio.com/docs/editor/debugging

https://developers.google.com/web/tools/chrome-devtools/?hl=ja
